\section{Message Definition -- PDU}
\label{sec:pdus}

In this section, we discuss the details of the \textsf{RCUC} protocol.

\subsection{Addressing}
\label{sec:pdus:addr}
\textsf{RCUC} protocol uses TCP/IP for transportation. It uses stream-oriented channels to send messages with no fixed sizes. [Note: We can customize port numbers to for specific task done by a device on the car. For example: We may want to assign base\_port\_number + device\_port\_index ex: 1010+1 = 1011 port no for air conditioner. ].

Based on port configuration we explained, a TCP connection is established to the \textsf{CCS} IP address and port number provided.
\subsection{Flow Control}
\label{sec:pdus:flow}
Flow control is dispatched to TCP/IP layer. [Note: As future extension, we may mention that we can enhance the flow control with adding asychrony in communication such as when client sends a message  and returns but sender send feedback later on. This reduces the congestion of network. In addition, we may buffer requests and flush them to server to save reduce communication overhead for each command.]
 
\subsection{PDU Definitions}
\label{sec:pdus:pdu}
\begin{itemize}
\item \textsf{Handshake}: is done via authentication.
\item \textsf{Utility Commands}: These are commands in between client and server. Client sends a command and waits for a response from server.
  \end{itemize}


PDU format is kept as generic as possible:
\[\textsf{CCS} \; | \; \textsf{C} \; : \; \textsf{Expr} \; | \; \textsf{ID} \; : \; \textsf{Size} \]
where \textsf{CCS} and \textsf{C} denotes whether message is sent by \textsf{CCS} server or client respectively. \textsf{Expr} and \textsf{ID} are data parts of the PDU chunks which represents either type/expression of the message, \textsf{Expr} or the unique device identifier, \textsf{ID}. \textsf{Size} is basically the number of bytesallocated for the message.

\subsubsection{Handshake}
\label{sec:pdus:pdu:hs}
\begin{itemize}
\item We assume that servers are already running. [Note: We can add one more phase for initialization of server but in that case ...]
\item When a client wants to connect to \textsf{CCS} server
  \[ \textsf{C} : \textsf{CON} : 1\]

  \item Then client sends its passwords back to the server.[Note: we can use DES encrpytion in here]. 
    \[\textsf{C} : \textsf{LOGIN} : 1\]
  \item If the response is incorrect, the server notifies with an error message and closes the connection:
    \[\textsf{CSS}:\textsf{ERROR}:1\]
    \item Otherwise \textsf{CCS} responds with start message
      \[\textsf{CSS} : \textsf{START} : 1\]
    \end{itemize}

\subsubsection{Client to Server Messages}
\label{sec:pdus:pdu:c_to_s}

After the connection is established which means client takes \textsf{START} messassage, client send command messages to server. 

Here how the message from client to server for a utility command packet looks like :
\[
\textsf{C}:\left\{ \begin{array}{ll}  \textsf{CMD}:1\\
                                      \textsf{COMMANDSEQNUM:1}\\
                                      \textsf{DEVICETYPE}:1 \\
                                       \textsf{DEVICENUM}:1 \\
                                      \textsf{DEVICECOMMANDTYPE}:1 \\
                                        \textsf{VALUE}:1

           \end{array} \right\}
\]                                        
where \textsf{CMD} denotes that client is sending a utility command. \textsf{COMMANDSEQNUM} denotes the squence number of the command which provides us bookkeeping for the messages in between server and client. \textsf{DEVICETYPE} denotes the unique identifier for a device. \textsf{DEVICENUM} is used to denote identify a specific item among set of items in same type. \textsf{DEVICECOMMANDTYPE} is identifier for a specific utility such as volume-up associated with a specific device. \textsf{VALUE} is the value to set.


So client can send a message like :

\[ [\textsf{CMD}]\;[12]\;[\textsf{RADIO}]\;[1]\;[\textsf{VOL\_UP}]\;[2]\]

which will increase the radio 1's volume 2 level up.

Another type of command from client to user is for choosing a specific car:
\[
\textsf{C}:\left\{ \begin{array}{ll}  \textsf{USER\_CAR}:1\\
                                      \textsf{COMMANDSEQNUM:1}\\
                                      \textsf{CAR\_ID:1}

           \end{array} \right\}
\]                                        


[Note: I think message format for client/server command can be refined. I gues we can discuss this.]


\paragraph{Assumption on Data at server}:  \hl{So each predefined device needs to have a :}
\[  [\textsf{DEVICETYPE}] [\textsf{DEVICENUM}] [\textsf{STATES}] [\textsf{ACTIONS}]\]
\hl{
For example : [MIRROR] [0$\ldots$n] [UP$\mid$DOWN] [VOL\_UP $\mid$ VOL\_DOWN ]. Server is assumed to have bunch of these which basically states that the device with type mirror, number (there can be more mirror in the car), state of the device and action to be performed on the device with a given value. [WE SHOULD DISCUSS THIS.We may chanage the protocol and add one more phase such as  initialization of server and let the clients to know about this initialization. I am not sure we should discuss.]}

\subsubsection{Server to Client Messages}
\label{sec:pdus:pdu:s_to_c}
There are two cases where server updates client:
\begin{itemize}
\item When client sent an command and the server updates with a confirmation that the action is applied or an error message.
  \end{itemize}

When a message is received from a server then its well-formedness verification is performed.
\begin{itemize}
\item \hl{[TODO: We can enforce a type/structure for device type identifier.]}
\item \hl{[TODO:We can enforce a type/structure for device number. ]}
\item \hl{[TODO: We can enforce constraints on which state received-command is legal to execute]}
  \item \hl{[TODO: Received parameters/values are legal for the command to be executed ]}
\end{itemize}

Server sends an update message :
\[
\textsf{CSS}:\left\{ \begin{array}{ll}  \textsf{ERROR}:1\\
                                      \textsf{LENMESSAGECHARS}:1 \\
                                       \textsf{ERRORMESSAGE}:1 

           \end{array} \right\}
\]
where \textsf{ERROR} denotes that server is sending an error message. \textsf{LENMESSAGECHARS} denotes the length of the error messages. \textsf{ERRORMESSAGE} denotes the error message's itself.

For the positive feedbacks to clients requests:
\[\textsf{CSS} : \left\{ \begin{array}{ll}  \textsf{APPLIED}:1\\
                                             \textsf{COMMANDSEQNUM}:1
\end{array} \right\}
\]

\subsection{Error Control}
\label{sec:pdus:err}
Error messages are raised when
\begin{itemize}
\item Server checks request and raise error if request message is not verified.
\item Authentication is not provided
  \end{itemize}
\input{pdus_qos}
